# 演習問題道場 機能仕様書

このドキュメントは、プログラミングブートキャンプ教材システムの**演習問題道場**機能の仕様を定義する。

---

## 目次

1. [概要](#概要)
2. [画面構成](#画面構成)
3. [出題範囲選択（ツリーダイアログ）](#出題範囲選択ツリーダイアログ)
4. [フィルター設定](#フィルター設定)
5. [フィルタリングパイプライン](#フィルタリングパイプライン)
6. [問題表示（演習中）](#問題表示演習中)
7. [ブラウザバック対応](#ブラウザバック対応)
8. [共有機能](#共有機能)
9. [コンポーネント構成](#コンポーネント構成)
10. [データモデル](#データモデル)

---

## 概要

### 目的

受講生が自分の苦手分野を効率的に復習できる演習問題の出題システムを提供する。出題範囲・フィルター条件を柔軟に設定し、繰り返し演習できる。

### 主要機能

- **出題範囲選択**: 4階層のツリーUIで大章・中章・トピック・個別問題を自由に選択
- **多軸フィルタリング**: 問題タイプ・難易度・達成状態・最終チェック日で絞り込み
- **出題設定**: 出題順（章順/ランダム）・出題数を制御
- **進捗追跡**: プログレスバーで演習の進捗をリアルタイム表示
- **結果サマリー**: 全問完了時にタイプ別正答率を表示、未達成問題の再出題
- **問題セット共有**: JSON形式で問題セットをエクスポート/インポート

### 対象ユーザー

- プログラミング未経験者〜初学者（受講生）
- 問題セットを配布する指導者

---

## 画面構成

道場は2つの画面で構成される。

### 設定画面（道場トップ）

```
┌──────────────────────────────────────────────────────────┐
│  演習問題道場                                               │
│                                                            │
│  ┌── 共有された問題セットを読み込む ──── ▶ (Accordion) ──┐ │
│  │  [テキストエリア: JSON を貼り付け]                      │ │
│  │  [読み込む]                                            │ │
│  └────────────────────────────────────────────────────┘ │
│                                                            │
│  ┌── 出題条件を設定 ──────────────────────────── Card ──┐ │
│  │  出題範囲: [出題範囲を選択する]  + 選択後Chip表示       │ │
│  │  問題タイプ: [KNOW ✓] [READ ✓] [WRITE ✓]              │ │
│  │  難易度: [Easy ✓] [Medium ✓] [Hard ✓]                 │ │
│  │  達成状態: [すべて] [未達成のみ] [達成済みのみ]          │ │
│  │  最終チェック日: [すべて ▼]                             │ │
│  │  出題順: [章の順番] [ランダム]                           │ │
│  │  出題数: [===●=====] 18問 / 45問  ☑全問出題           │ │
│  │  フィルタ適用後: 18問                                   │ │
│  │  [ 演習を開始する ]                                     │ │
│  └────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
```

### 演習画面（問題一覧）

```
┌──────────────────────────────────────────────────────────┐
│  [← 条件を変更する]              [この問題セットを共有]     │
│                                                            │
│  進捗  ━━━━━━━━━━━━━━━━━━  3/18問完了                  │
│                                                            │
│  ▼ 問題1. タイトル  [KNOW] [Easy] ✅                       │
│  ▼ 問題2. タイトル  [READ] [Medium]                        │
│  ► 問題3. ...                                              │
│                                                            │
│  （全問完了時: 結果サマリー + 再出題ボタン）                  │
└──────────────────────────────────────────────────────────┘
```

---

## 出題範囲選択（ツリーダイアログ）

### UI

- 「出題範囲を選択する」ボタンでフルスクリーンダイアログを表示
- MUI `Dialog(fullScreen)` + `List` + `Collapse` + `Checkbox` で構成

### 階層構造

```
大章（Java, Spring, DB, ...）
  └─ 中章（基本文法, OOP, ...）
      └─ トピック（変数と型, 条件分岐, ...）
          └─ 個別問題（変数の概念を説明できる, ...）
```

### チェックボックスの伝搬ルール

| 操作 | 結果 |
|------|------|
| 親をチェック | 配下の子がすべてチェックされる |
| 親のチェックを外す | 配下の子がすべてチェック解除される |
| 子を個別に外す | 親は `indeterminate` 状態になる |
| 全ての子をチェック | 親が `checked` に変わる |

### 問題数の表示

各ノードの右側に `Chip` で問題数を表示（例: `45問`）。

### 上部操作

- **全選択ボタン**: すべての問題をチェック
- **全解除ボタン**: すべてのチェックを解除
- **確定ボタン**: 選択した問題数を表示して確定

---

## フィルター設定

### 問題タイプ（Chip選択）

| 値 | 説明 |
|----|------|
| `KNOW` | 知識問題（概念や用語の理解） |
| `READ` | 読解問題（コードの読み取り） |
| `WRITE` | 記述問題（コードの作成） |

- 選択中: `filled` + `primary` + チェックアイコン
- 非選択: `outlined` + `default` + 薄い表示（opacity: 0.5）
- デフォルト: 全選択

### 難易度（Chip選択）

| 値 | 説明 |
|----|------|
| `Easy` | 基礎的な問題 |
| `Medium` | 応用問題 |
| `Hard` | 発展問題 |

- UIは問題タイプと同様
- デフォルト: 全選択

### 達成状態（ToggleButtonGroup）

| 値 | 説明 |
|----|------|
| `all` | すべての問題を表示 |
| `unachieved` | 未達成の問題のみ |
| `achieved` | 達成済みの問題のみ |

- デフォルト: `all`

### 最終チェック日（Select）

| 値 | 説明 |
|----|------|
| `all` | すべて |
| `3` | 3日以上前に達成した問題 |
| `7` | 7日以上前に達成した問題 |
| `14` | 14日以上前に達成した問題 |
| `30` | 30日以上前に達成した問題 |

- デフォルト: `all`
- **条件付き表示**: 達成状態が `unachieved` の場合、未達成問題にはチェック日が存在しないためこのフィルタは自動的に非表示になり、値は `all` にリセットされる

### 出題順（ToggleButtonGroup）

| 値 | 説明 |
|----|------|
| `sequential` | `structure.ts` の定義順（章の順番）で出題 |
| `random` | Fisher-Yates アルゴリズムでシャッフル |

- デフォルト: `sequential`

### 出題数（Slider + TextField）

- 「全問出題」チェックボックス付き（デフォルト: ON）
- OFFの場合、Slider + 数値入力で1〜フィルタ適用後の問題数の範囲で指定
- フィルター条件の変化に応じてSliderの最大値がリアルタイムに更新される
- フィルタ適用後の問題数が0の場合、SliderとTextFieldはdisabledになる

### サマリー

フィルタ設定の下部にリアルタイムで `フィルタ適用後: XX問` を表示。

---

## フィルタリングパイプライン

フィルタは以下の順序で適用される。

```
ツリーで選択された問題ID群
  → 問題タイプフィルタ (KNOW / READ / WRITE)
  → 難易度フィルタ (Easy / Medium / Hard)
  → 達成状態フィルタ (all / achieved / unachieved)
  → 最終チェック日フィルタ (N日以上前)  ※達成状態が unachieved の場合スキップ
  → 出題順 (sequential / random)
  → 出題数制限 (先頭N件)
  → 最終問題リスト
```

実装: `docs/src/lib/dojoFilter.ts` の `resolveDojoQuestions()` 関数

---

## 問題表示（演習中）

### 達成状況バー

- `LinearProgress` で視覚的に達成率を表示
- 右上に `X/Y問 達成` のテキスト表示
- 達成状態はlocalStorageのデータとリアルタイムに連動
- バー下部に補足テキスト:「自動採点のない問題は、解答確認後にチェックボックスで達成を記録してください」

### 達成の定義（問題形式別）

問題は自動採点の有無により、達成の記録方法が異なる。

| 問題形式 | 採点方式 | 達成の記録方法 |
|----------|---------|---------------|
| `multipleChoice`（選択式） | 自動採点 | 正解時に自動で達成。不正解時は達成解除 |
| `fillInBlank`（穴埋め式） | 自動採点 | 正解時に自動で達成。不正解時は達成解除 |
| `freeText`（自由記述） | 手動 | ユーザーが解答を確認し、達成チェックボックスを手動でON |

いずれの形式でも、達成状態は `useStoredProgress` フックの `progress[questionId]` で統一的に管理される。進捗バーやサマリーはこの達成状態のみを参照するため、採点方式の違いを意識する必要はない。

### 問題一覧

- `Accordion` で各問題を展開/折りたたみ表示
- **すべての問題がデフォルトで展開状態**（達成状態によらない）
- 各問題の表示要素:
  - 通し番号（`問題1.` `問題2.` ...）
  - 問題タイトル
  - タイプChip（`KNOW` `READ` `WRITE`）
  - 難易度Chip（`Easy` `Medium` `Hard`）
  - 達成アイコン（CheckCircle、達成済みの場合のみ）
- 問題本体は `QuestionRenderer` コンポーネント（mode="dojo"）で表示

### 結果サマリー

全問達成時に以下を表示:

- 「全 X問 達成！（達成率 100%）」
- タイプ別の達成数（KNOW: X/Y, READ: X/Y, WRITE: X/Y）

### 再出題

未達成の問題がある場合、「未達成の問題だけ再出題（X問）」ボタンを表示。クリックすると未達成問題のみで再度演習画面を表示する。

再出題は1セッション内で複数回繰り返すことができる。再出題時には直前の問題セットが履歴スタックに保存され、ブラウザバックで直前の問題セットに戻ることができる（詳細は[ブラウザバック対応](#ブラウザバック対応)を参照）。

---

## ブラウザバック対応

問題道場では条件設定画面と演習画面が同一URL上の `screen` state で切り替わるため、History API を用いて画面遷移をブラウザ履歴と連動させる。

### URL設計

| 画面状態 | URLハッシュ | 説明 |
|----------|-----------|------|
| 条件設定画面 | なし | 初期状態・通常のURL |
| 演習画面（初回出題） | `#questions` | `handleStart` / `handleImport` 時に `pushState` |
| 演習画面（1回目の再出題） | `#retry-1` | `handleRetryWrong` 時に `pushState` |
| 演習画面（N回目の再出題） | `#retry-N` | 再出題ごとにカウンターをインクリメント |

### 履歴スタックの例

```
設定画面 → #questions → #retry-1 → #retry-2
                                      ↑ 現在地
```

ブラウザバックを押すと `#retry-1` の問題セットに戻る。さらにバックで `#questions` に戻る。

### 再出題履歴の管理

- `questionHistoryRef`（`useRef<Question[][]>`）で過去の問題セットをスタックとして保持
- `retryCountRef`（`useRef<number>`）で再出題回数を追跡（URLハッシュ生成用）
- `useRef` を使用する理由: `popstate` イベントハンドラ内でstale closureを回避するため

### popstate ハンドラの動作

| 条件 | 動作 |
|------|------|
| 履歴スタックが空でない | スタックから前の問題セットを pop → `replaceState` でハッシュを1つ前に戻す → 前の問題セットで画面を再描画 |
| 履歴スタックが空 | 確認ダイアログを表示（`pushState` で現在のURLを維持） |

### 確認ダイアログ

演習画面から条件設定画面に戻る際（履歴スタックが空の状態でブラウザバック）に確認ダイアログを表示する。

- **タイトル**: 「条件設定に戻りますか？」
- **本文**: 「現在の問題セットは破棄されます。ランダム出題の場合、同じ並び順を再現することはできません。」
- **アクション**:
  - 「キャンセル」: ダイアログを閉じ、演習画面に留まる
  - 「戻る」: 条件設定画面に遷移し、URLハッシュを除去

### 「条件を変更する」ボタン

UI上の「条件を変更する」ボタンクリック時は、確認ダイアログを表示せずに直接条件設定画面に戻る。この際、履歴スタックとカウンターをリセットし、`replaceState` でハッシュを除去する。

### エッジケース

| シナリオ | 対処 |
|---------|------|
| 再出題後のブラウザバック | 履歴スタックから前の問題セットを復元 |
| 複数回の再出題後に一気に戻る | バックのたびにスタックを1つずつpop（段階的に遡る） |
| ダイアログ表示中に再度バック | `pushState` 済みのため再度 `popstate` が発火 → ダイアログは既にopen |
| 設定画面でのブラウザバック | `popstate` リスナー未登録のため通常のブラウザバック動作 |
| `#questions` / `#retry-*` 付きURL直接アクセス | マウント時にハッシュを除去し、設定画面を表示 |
| 「条件を変更する」ボタンで戻った後の「進む」 | `replaceState` でハッシュを除去しているため、「進む」は無効 |

---

## 共有機能

問題セットの共有は**フィルタ条件ではなく、生成後の問題ID一覧**をやり取りする。

### 共有データ形式

```typescript
interface DojoShareData {
  v: 1;                // バージョン番号（将来の後方互換性用）
  ids: number[];       // 問題インデックスの配列
}
```

- インデックスは `ALL_TOPIC_STRUCTURE.flatMap(t => t.questions)` の配列上の通し番号（0始まり）
- JSON形式のみサポート

### エンコード例

```json
{"v":1,"ids":[0,1,2,15,20,45,88,120]}
```

### エクスポート

- 演習画面上部の「この問題セットを共有」ボタンから起動
- ダイアログにJSON文字列を表示
- 「コピー」ボタンでクリップボードにコピー（Snackbarで完了通知）

### インポート

- 設定画面上部の「共有された問題セットを読み込む」Accordion内
- テキストエリアにJSON文字列を貼り付けて「読み込む」ボタンで実行
- バリデーション成功: フィルタ設定をスキップして直接演習画面を表示
- バリデーション失敗: エラーメッセージを表示

### バリデーションルール

| チェック項目 | エラーメッセージ |
|-------------|----------------|
| JSONとしてパースできない | 「JSONの形式が正しくありません」 |
| オブジェクトでない | 「形式が正しくありません」 |
| `v` が 1 でない | 「サポートされていないバージョンです」 |
| `ids` が配列でない | 「問題IDの配列が見つかりません」 |
| `ids` の要素が数値でない | 「問題IDの形式が正しくありません」 |
| 有効な問題が0件 | 「有効な問題が見つかりません」 |

実装: `docs/src/lib/dojoShare.ts`

---

## コンポーネント構成

### ファイル一覧

| ファイル | 役割 |
|---------|------|
| `components/dojo/DojoContent.tsx` | メインコンテナ。状態管理・画面遷移（設定↔演習）・History API連携・ブラウザバック確認ダイアログを制御 |
| `components/dojo/DojoTopicSelector.tsx` | 出題範囲選択のフルスクリーンツリーダイアログ |
| `components/dojo/DojoFilterPanel.tsx` | フィルター設定パネル（Chip・ToggleButton・Slider等） |
| `components/dojo/DojoImportPanel.tsx` | 共有インポートUI（Accordion形式） |
| `components/dojo/DojoQuestionView.tsx` | 演習中の問題一覧・プログレスバー・結果サマリー |
| `components/dojo/DojoExportDialog.tsx` | エクスポートダイアログ（JSONテキスト+コピーボタン） |
| `lib/dojoFilter.ts` | フィルタリングパイプライン関数 |
| `lib/dojoShare.ts` | 共有データのエンコード/デコード/バリデーション |

### コンポーネントツリー

```
DojoContent
├── DojoImportPanel
├── DojoFilterPanel
│   └── (内部にSlider, Chip, ToggleButtonGroup等)
├── DojoTopicSelector (Dialog)
└── DojoQuestionView
    ├── QuestionRenderer (各問題の表示)
    └── DojoExportDialog (Dialog)
```

### 依存する既存コンポーネント/ユーティリティ

| モジュール | 用途 |
|-----------|------|
| `QuestionRenderer` | 問題本体の表示（mode="dojo"） |
| `useStoredProgress` | localStorageの進捗データ読み書き |
| `lib/date.ts` の `daysAgo()` | 最終チェック日フィルタの日数計算 |
| `structure.ts` | 全トピック・問題のマスタデータ |

---

## データモデル

### フィルタオプション（DojoFilterOptions）

```typescript
interface DojoFilterOptions {
  selectedQuestionIds: Set<string>;       // ツリーで選択された問題ID
  selectedTypes: Set<QuestionType>;       // KNOW / READ / WRITE
  selectedDifficulties: Set<Difficulty>;  // Easy / Medium / Hard
  achievementFilter: AchievementFilter;   // all / achieved / unachieved
  daysAgoFilter: DaysAgoFilter;           // all / 3 / 7 / 14 / 30
  orderMode: OrderMode;                   // sequential / random
  questionLimit: number | null;           // nullなら全問
  progress: ProgressRecord;               // localStorageの進捗データ
}
```

### 共有データ（DojoShareData）

```typescript
interface DojoShareData {
  v: 1;
  ids: number[];
}
```

### 進捗データ（ProgressRecord） — 既存

```typescript
type ProgressRecord = Record<string, {
  lastCheckedAt: string;  // ISO 8601文字列
}>;
```

ストレージキー: `questionProgress`
