# Spring Securityã§ã®ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè£… â€” æ¼”ç¿’å•é¡Œ

---

## ğŸ§  KNOWï¼ˆçŸ¥è­˜ç¢ºèªï¼‰

### KNOW-1ï¼šèªè¨¼(Authentication)ã¨èªå¯(Authorization)ã®é•ã„ã‚’ç†è§£ã—ã¦ã„ã‚‹

**å•é¡Œï¼š**  
æ¬¡ã®èª¬æ˜ã®ã†ã¡ã€æ­£ã—ã„çµ„ã¿åˆã‚ã›ã‚’é¸ã¹ã€‚

> ï¼ˆAï¼‰èªè¨¼ï¼ˆAuthenticationï¼‰ã¨ã¯ã€èª°ãªã®ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨  
> ï¼ˆBï¼‰èªå¯ï¼ˆAuthorizationï¼‰ã¨ã¯ã€ä½•ã‚’ã—ã¦ã‚ˆã„ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨  

**å›ç­”ï¼š**  
ï¼ˆAï¼‰ï¼ãƒ­ã‚°ã‚¤ãƒ³ã€ï¼ˆBï¼‰ï¼ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã®ç¢ºèª

**è§£èª¬ï¼š**  
èªè¨¼ã¯ã€Œæœ¬äººç¢ºèªã€ã€èªå¯ã¯ã€Œæ“ä½œæ¨©é™ã®ç¢ºèªã€ã€‚  
Spring Securityã§ã¯ä¸¡æ–¹ã‚’ä¸€å…ƒç®¡ç†ã§ãã‚‹ã€‚

---

### KNOW-2ï¼šUserDetailsService ã®å½¹å‰²ã‚’èª¬æ˜ã§ãã‚‹

**å•é¡Œï¼š**  
Spring Securityã«ãŠã‘ã‚‹ `UserDetailsService` ã®å½¹å‰²ã‚’ç°¡æ½”ã«èª¬æ˜ã›ã‚ˆã€‚

**å›ç­”ï¼š**  
ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å…¥åŠ›ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’åŸºã«DBã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã€èªè¨¼å‡¦ç†ã«æ¸¡ã™å½¹å‰²ã‚’æŒã¤ã€‚

**è§£èª¬ï¼š**  
Spring Securityã¯ `UserDetailsService#loadUserByUsername()` ã‚’è‡ªå‹•ã§å‘¼ã³å‡ºã—ã€  
è¿”å´ã•ã‚ŒãŸ `UserDetails` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã£ã¦èªè¨¼ã‚’è¡Œã†ã€‚

---

### KNOW-3ï¼šBCryptPasswordEncoder ã«ã‚ˆã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ã®ä»•çµ„ã¿ã‚’ç†è§£ã—ã¦ã„ã‚‹

**å•é¡Œï¼š**  
æ¬¡ã®é¸æŠè‚¢ã‹ã‚‰ã€BCryptã®ç‰¹å¾´ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã‚’é¸ã¹ã€‚

> â‘  åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚‚æ¯å›ç•°ãªã‚‹ãƒãƒƒã‚·ãƒ¥å€¤ã«ãªã‚‹  
> â‘¡ ã‚½ãƒ«ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãƒãƒƒã‚·ãƒ¥åŒ–ã™ã‚‹  
> â‘¢ å¾©å·ï¼ˆã‚‚ã¨ã«æˆ»ã™ï¼‰ã“ã¨ãŒã§ãã‚‹  
> â‘£ Spring SecurityãŒè‡ªå‹•ã§ç…§åˆã—ã¦ãã‚Œã‚‹  

**å›ç­”ï¼š**  
â‘ ã€â‘¡ã€â‘£

**è§£èª¬ï¼š**  
BCryptã¯ã‚½ãƒ«ãƒˆã‚’å«ã‚€ä¸€æ–¹å‘ãƒãƒƒã‚·ãƒ¥ã§å®‰å…¨æ€§ãŒé«˜ã„ã€‚  
ç…§åˆã¯ `PasswordEncoder.matches()` ãŒå†…éƒ¨ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

---

## ğŸ‘€ READï¼ˆã‚³ãƒ¼ãƒ‰ç†è§£ï¼‰

### READ-1ï¼šSecurityFilterChain ã®è¨­å®šå†…å®¹ã‹ã‚‰èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’èª­ã¿å–ã‚Œã‚‹

**å•é¡Œï¼š**  
æ¬¡ã®è¨­å®šã‚¯ãƒ©ã‚¹ã®å‹•ä½œã‚’èª¬æ˜ã›ã‚ˆã€‚

```java
http
  .authorizeHttpRequests(auth -> auth
      .requestMatchers("/login", "/css/**").permitAll()
      .anyRequest().authenticated()
  )
  .formLogin(login -> login
      .loginPage("/login")
      .defaultSuccessUrl("/home")
  )
  .logout(logout -> logout
      .logoutUrl("/logout")
      .logoutSuccessUrl("/login?logout")
  );
```

**å›ç­”ï¼š**  
- `/login` ã‚„ `/css/**` ã¯èªè¨¼ä¸è¦  
- ãã‚Œä»¥å¤–ã®ãƒšãƒ¼ã‚¸ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦  
- `/login` ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã€æˆåŠŸæ™‚ã¯ `/home` ã¸é·ç§»  
- `/logout` ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç ´æ£„ã—ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ãã‚‹

**è§£èª¬ï¼š**  
ã“ã®è¨­å®šã ã‘ã§ã€èªè¨¼ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢é·ç§»ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒè‡ªå‹•åŒ–ã•ã‚Œã‚‹ã€‚

---

### READ-2ï¼šUserDetailsService å®Ÿè£…ã‚¯ãƒ©ã‚¹ã® loadUserByUsername() ã®å‹•ä½œã‚’ç†è§£ã—ã¦ã„ã‚‹

**å•é¡Œï¼š**  
æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å `"taro"` ãŒå­˜åœ¨ã—ãªã‹ã£ãŸå ´åˆã©ã†ãªã‚‹ã‹ã€‚

```java
@Override
public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
    var user = userMapper.findByUsername(username);
    if (user == null) {
        throw new UsernameNotFoundException("User not found: " + username);
    }
    return User.builder()
            .username(user.getUsername())
            .password(user.getPassword())
            .roles(user.getRole())
            .build();
}
```

**å›ç­”ï¼š**  
`UsernameNotFoundException` ãŒé€å‡ºã•ã‚Œã€ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ã¨ãªã‚‹ã€‚

**è§£èª¬ï¼š**  
Spring SecurityãŒã“ã®ä¾‹å¤–ã‚’æ¤œçŸ¥ã—ã€è‡ªå‹•çš„ã« `/login?error` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã€‚

---

### READ-3ï¼šSpring SecurityãŒãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ä¿å­˜ã™ã‚‹æƒ…å ±ã‚’ç†è§£ã—ã¦ã„ã‚‹

**å•é¡Œï¼š**  
Spring SecurityãŒãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã« `HttpSession` ã«è‡ªå‹•ã§ä¿å­˜ã™ã‚‹ä¸»ãªæƒ…å ±ã‚’2ã¤æŒ™ã’ã‚ˆã€‚

**å›ç­”ï¼š**  
- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ï¼ˆ`Principal`ï¼‰  
- æ¨©é™ï¼ˆ`ROLE_USER` ãªã©ï¼‰

**è§£èª¬ï¼š**  
Spring Securityã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é€šã—ã¦èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿æŒã—ã€  
æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è‡ªå‹•çš„ã«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã†ã€‚

---

## âœï¸ WRITEï¼ˆå®Ÿè£…ï¼‰

### WRITE-1ï¼šSpring Securityã¨MyBatisã‚’çµ„ã¿åˆã‚ã›ã¦DBèªè¨¼ã‚’è¡Œã†æ§‹æˆã‚’å®Ÿè£…ã§ãã‚‹

**å•é¡Œï¼š**  
MyBatisã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã€Spring Securityã§èªè¨¼ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€  
`UserDetailsService` ã‚’ã©ã®ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã‹ç¤ºã›ã€‚

**å›ç­”ï¼š**

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {

    private final UserMapper userMapper;

    public CustomUserDetailsService(UserMapper userMapper) {
        this.userMapper = userMapper;
    }

    @Override
    public UserDetails loadUserByUsername(String username)
            throws UsernameNotFoundException {
        var user = userMapper.findByUsername(username);
        if (user == null) throw new UsernameNotFoundException(username);
        return User.builder()
                .username(user.getUsername())
                .password(user.getPassword())
                .roles(user.getRole())
                .build();
    }
}
```

**è§£èª¬ï¼š**  
`UserDetailsService` ãŒSpring Securityã®èªè¨¼å…¥å£ã€‚  
`User` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¦è¿”ã™ã“ã¨ã§ã€SecurityConfigã‹ã‚‰èªè¨¼å¯èƒ½ã«ãªã‚‹ã€‚

---

### WRITE-2ï¼šSecurityConfigã‚’ä½œæˆã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç”»é¢ã®ãƒ«ãƒ¼ãƒˆã‚’è¨­å®šã§ãã‚‹

**å•é¡Œï¼š**  
Spring Securityã§ `/login` ã¨ `/logout` ã®ãƒ«ãƒ¼ãƒˆã‚’è¨­å®šã™ã‚‹SecurityConfigã‚’è¨˜è¿°ã›ã‚ˆã€‚

**å›ç­”ï¼š**

```java
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
          .authorizeHttpRequests(auth -> auth
              .requestMatchers("/login").permitAll()
              .anyRequest().authenticated()
          )
          .formLogin(login -> login
              .loginPage("/login")
              .defaultSuccessUrl("/home", true)
              .permitAll()
          )
          .logout(logout -> logout
              .logoutUrl("/logout")
              .logoutSuccessUrl("/login?logout")
              .permitAll()
          );
        return http.build();
    }
}
```

**è§£èª¬ï¼š**  
ãƒ•ã‚©ãƒ¼ãƒ ãƒ­ã‚°ã‚¤ãƒ³ãƒ»èªè¨¼å¿…é ˆURLãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’  
`SecurityFilterChain` ã§å®£è¨€çš„ã«è¨­å®šã™ã‚‹ã€‚

---

### WRITE-3ï¼šBCryptPasswordEncoderã‚’ä½¿ã£ã¦å®‰å…¨ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã§ãã‚‹

**å•é¡Œï¼š**  
Javaã‚³ãƒ¼ãƒ‰ã§æ–‡å­—åˆ— `"pass"` ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã‘ã€‚

**å›ç­”ï¼š**

```java
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

public class PasswordGenerator {
    public static void main(String[] args) {
        BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
        System.out.println(encoder.encode("pass"));
    }
}
```

**è§£èª¬ï¼š**  
BCryptã¯ä¸€æ–¹å‘ãƒãƒƒã‚·ãƒ¥ã§ã‚ã‚Šã€åŒã˜æ–‡å­—åˆ—ã§ã‚‚ç•°ãªã‚‹ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆã™ã‚‹ã€‚  
ã“ã®å€¤ã‚’DBã«ç™»éŒ²ã™ã‚Œã°å®‰å…¨ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ‰±ãˆã‚‹ã€‚
